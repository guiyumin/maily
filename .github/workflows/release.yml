name: Release

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write

jobs:
  release-macos:
    strategy:
      matrix:
        include:
          - runner: macos-14
            goarch: amd64
          - runner: macos-14
            goarch: arm64
    runs-on: ${{ matrix.runner }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.23"

      - name: Extract version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Build
        env:
          CGO_ENABLED: 1
          GOOS: darwin
          GOARCH: ${{ matrix.goarch }}
        run: |
          # Set up cross-compilation for amd64 on ARM runner
          if [ "${{ matrix.goarch }}" = "amd64" ]; then
            export CC="clang -arch x86_64"
            export CXX="clang++ -arch x86_64"
          fi
          go build -ldflags "-s -w -X maily/internal/version.Version=${{ steps.version.outputs.VERSION }} -X maily/internal/version.Commit=${{ github.sha }} -X maily/internal/version.Date=$(date -u +%Y-%m-%dT%H:%M:%SZ)" -o maily .
          zip maily_${{ steps.version.outputs.VERSION }}_darwin_${{ matrix.goarch }}.zip maily README.md LICENSE*

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: maily-darwin-${{ matrix.goarch }}
          path: maily_${{ steps.version.outputs.VERSION }}_darwin_${{ matrix.goarch }}.zip

  release-linux:
    strategy:
      matrix:
        goarch: [amd64, arm64]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.23"

      - name: Extract version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Build
        env:
          CGO_ENABLED: 0
          GOOS: linux
          GOARCH: ${{ matrix.goarch }}
        run: |
          go build -ldflags "-s -w -X maily/internal/version.Version=${{ steps.version.outputs.VERSION }} -X maily/internal/version.Commit=${{ github.sha }} -X maily/internal/version.Date=$(date -u +%Y-%m-%dT%H:%M:%SZ)" -o maily .
          tar -czvf maily_${{ steps.version.outputs.VERSION }}_linux_${{ matrix.goarch }}.tar.gz maily README.md LICENSE*

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: maily-linux-${{ matrix.goarch }}
          path: maily_${{ steps.version.outputs.VERSION }}_linux_${{ matrix.goarch }}.tar.gz

  publish:
    needs: [release-macos, release-linux]
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Extract version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Prepare release files
        run: |
          mkdir -p release
          # macOS
          cp dist/maily-darwin-amd64/*.zip release/
          cp dist/maily-darwin-arm64/*.zip release/
          # Linux
          cp dist/maily-linux-amd64/*.tar.gz release/
          cp dist/maily-linux-arm64/*.tar.gz release/
          # Create latest naming
          cp release/maily_${{ steps.version.outputs.VERSION }}_darwin_amd64.zip release/maily-darwin-amd64.zip
          cp release/maily_${{ steps.version.outputs.VERSION }}_darwin_arm64.zip release/maily-darwin-arm64.zip
          cp release/maily_${{ steps.version.outputs.VERSION }}_linux_amd64.tar.gz release/maily-linux-amd64.tar.gz
          cp release/maily_${{ steps.version.outputs.VERSION }}_linux_arm64.tar.gz release/maily-linux-arm64.tar.gz
          # Generate checksums
          cd release && sha256sum *.zip *.tar.gz > checksums.txt

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            release/maily_${{ steps.version.outputs.VERSION }}_darwin_amd64.zip
            release/maily_${{ steps.version.outputs.VERSION }}_darwin_arm64.zip
            release/maily_${{ steps.version.outputs.VERSION }}_linux_amd64.tar.gz
            release/maily_${{ steps.version.outputs.VERSION }}_linux_arm64.tar.gz
            release/maily-darwin-amd64.zip
            release/maily-darwin-arm64.zip
            release/maily-linux-amd64.tar.gz
            release/maily-linux-arm64.tar.gz
            release/checksums.txt
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  homebrew:
    needs: publish
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Extract version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Update Homebrew tap
        env:
          TAP_GITHUB_TOKEN: ${{ secrets.TAP_GITHUB_TOKEN }}
          VERSION: ${{ steps.version.outputs.VERSION }}
        run: |
          # Download checksums
          curl -sL "https://github.com/guiyumin/maily/releases/download/v${VERSION}/checksums.txt" -o checksums.txt
          AMD64_SHA=$(grep "maily_${VERSION}_darwin_amd64" checksums.txt | awk '{print $1}')
          ARM64_SHA=$(grep "maily_${VERSION}_darwin_arm64" checksums.txt | awk '{print $1}')

          # Clone tap repo and update formula
          git clone https://x-access-token:${TAP_GITHUB_TOKEN}@github.com/guiyumin/homebrew-tap.git
          cd homebrew-tap

          # Update version and URLs
          sed -i "s/version \".*\"/version \"${VERSION}\"/" Formula/maily.rb
          sed -i "s|releases/download/v[^/]*/maily_[^_]*_darwin_arm64|releases/download/v${VERSION}/maily_${VERSION}_darwin_arm64|" Formula/maily.rb
          sed -i "s|releases/download/v[^/]*/maily_[^_]*_darwin_amd64|releases/download/v${VERSION}/maily_${VERSION}_darwin_amd64|" Formula/maily.rb

          # Update sha256 checksums
          sed -i "/darwin_arm64/{ n; s/sha256 \".*\"/sha256 \"${ARM64_SHA}\"/; }" Formula/maily.rb
          sed -i "/darwin_amd64/{ n; s/sha256 \".*\"/sha256 \"${AMD64_SHA}\"/; }" Formula/maily.rb

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/maily.rb
          git commit -m "maily: update to v${VERSION}"
          git push
